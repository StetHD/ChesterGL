function i(g){throw g;}var j=true,l=null,o=false;function r(g){var a=new Float32Array(2);g&&(a[0]=g[0],a[1]=g[1]);return a}HTMLCanvasElement.Ab=vec3.create();function z(g,a){var c=HTMLCanvasElement.Ab;c[0]=0;c[1]=0;a.x!==void 0&&a.y!==void 0?(c[0]=a.x,c[1]=a.y):(c[0]=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,c[1]=a.clientY+document.body.scrollTop+document.documentElement.scrollTop);c[0]-=g.offsetLeft;c[1]=g.height-(c[1]-g.offsetTop);return c}
window.ob=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(g){window.setTimeout(g,1E3/60)};function F(g,a){console.log(WebGLDebugUtils.glEnumToString(g)+" was caused by call to "+a)}window.requestAnimFrame=window.ob;
(function(g){var a={a:function(a,b,d){a[b]=d},b:l,Y:o,xb:o,mb:{},Ya:l,M:l,U:l,canvas:l,ga:"3d",d:j,Pa:o,l:{},qa:{},Z:{},ra:{}};a.fb=Date.now();a.R=0;a.dc=0;a.va=l;a.Db="debug-info";a.update=l;a.p={Ra:0,Sa:1,Ta:2};a.q=[];a.V=function(a){var b=this.mb[a],d=this.b;if(a!=this.Ya){console.log("selecting program "+a);this.Ya=a;d.validateProgram(b);d.useProgram(b);for(var e in b.e)d.enableVertexAttribArray(b.e[e])}return b};a.Ub=function(a){this.Ib(document.getElementById(a));this.d&&this.Hb();this.va=document.getElementById("debug-info");
this.Fa("texture",this.Fb);this.nb("texture",this.Gb);this.nb("default",this.Eb)};a.Ib=function(a){try{if(this.canvas=a,this.d&&(this.b=a.getContext("experimental-webgl",{alpha:o,antialias:o}))&&g.WebGLDebugUtils)console.log("installing debug context"),this.b=WebGLDebugUtils.makeDebugContext(this.b,F)}catch(b){console.log("ERROR: "+b)}if(!this.b)this.b=a.getContext("2d"),this.Pa?(this.ca=document.createElement("canvas"),this.ca.width=a.width,this.ca.height=a.height,this.n=this.ca.getContext("2d"),
this.n.O=a.width,this.n.G=a.height,this.a(this,"offContext",this.n),this.a(this.n,"viewportWidth",this.n.O),this.a(this.n,"viewportHeight",this.n.G)):this.n=this.b,(!this.b||!this.n)&&i("Error initializing graphic context!"),this.d=o;this.a(this,"gl",this.b);this.Wa();this.Jb()};a.Wa=function(){var a=this.canvas;this.b.O=a.width;this.b.G=a.height;this.a(this.b,"viewportWidth",this.b.O);this.a(this.b,"viewportHeight",this.b.G)};a.Hb=function(){var c=this.b;this.aa("default",function(b){b.F=c.getUniformLocation(b,
"uMVPMatrix");b.e={vertexPositionAttribute:c.getAttribLocation(b,"aVertexPosition"),vertexColorAttribute:c.getAttribLocation(b,"aVertexColor")};a.a(b,"mvpMatrixUniform",b.F);a.a(b,"attribs",b.e)});this.aa("texture",function(b){b.F=c.getUniformLocation(b,"uMVPMatrix");b.Ka=c.getUniformLocation(b,"uSampler");b.e={vertexColorAttribute:c.getAttribLocation(b,"aVertexColor"),textureCoordAttribute:c.getAttribLocation(b,"aTextureCoord"),vertexPositionAttribute:c.getAttribLocation(b,"aVertexPosition")};a.a(b,
"mvpMatrixUniform",b.F);a.a(b,"samplerUniform",b.Ka);a.a(b,"attribs",b.e)})};a.aa=function(a,b){var d=this.b,e=this.ib(a,"frag"),f=this.ib(a,"vert"),k=d.createShader(d.FRAGMENT_SHADER);d.shaderSource(k,e);d.compileShader(k);d.getShaderParameter(k,d.COMPILE_STATUS)?(e=d.createShader(d.VERTEX_SHADER),d.shaderSource(e,f),d.compileShader(e),d.getShaderParameter(e,d.COMPILE_STATUS)?(d=this.createShader(a,k,e),b&&b(d)):console.log("problem compiling vertex shader "+a+"("+d.getShaderInfoLog(e)+"):\n"+f)):
console.log("problem compiling fragment shader "+a+"("+d.getShaderInfoLog(k)+"):\n"+e)};a.ib=function(a,b){var d=l;$.ajax({url:"shaders/"+a+"."+b,async:o,type:"GET",success:function(a,b){b=="success"?d=a:console.log("error getting the shader data")}});return d};a.createShader=function(a,b,d){var e=this.b,f=e.createProgram();e.attachShader(f,b);e.attachShader(f,d);e.linkProgram(f);e.getProgramParameter(f,e.LINK_STATUS)||console.log("problem linking shader");return this.mb[a]=f};a.Fa=function(a,b){this.qa[a]=
b};a.nb=function(a,b){this.Z[a]=b};a.u=function(a,b,d){var e=void 0;if(typeof b=="object")e=b.dataType,b=b.path;this.l[a]||(this.l[a]={});var f=this.l[a];if(f[b])if(f[b].status=="loading")d&&f[b].S.push(d);else if(f[b].status=="loaded")d&&d(f[b].data);else{if(f[b].status=="try"){f[b].status="loading";if(this.Z[a])this.Z[a](a,{url:b,dataType:e});else this.Z["default"](a,{url:b,dataType:e});d&&f[b].S.push(d)}}else f[b]={data:l,status:"try",S:[]},d&&f[b].S.push(d),this.u(a,{path:b,dataType:e})};a.Q=
function(a,b){var d=this.ra[a];d||(this.ra[a]=[],d=this.ra[a]);b&&d.push(b);var e=j;if(a=="all")for(var f in this.l){var k=this.l[f],h;for(h in k)if(k[h].status!="loaded"){e=o;break}if(!e)break}else for(h in k=this.l[a],k)if(k[h].status!="loaded"){e=o;break}if(e)for(;e=d.shift();)e()};a.K=function(a,b){return this.l[a][b].data};a.Qb=function(a){var b=this.b,d=j;try{var e=0;b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,1);b.activeTexture(b.TEXTURE0);b.bindTexture(b.TEXTURE_2D,a.ja);b.texImage2D(b.TEXTURE_2D,
0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a);e=b.getError();e!=0&&(console.log("gl error "+e),d=o);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);b.bindTexture(b.TEXTURE_2D,l)}catch(f){console.log("got some error: "+f),d=o}return d};a.Fb=function(c,b){if(a.d)b.ja=a.b.createTexture();a.l.texture[c].data=b;return a.d?a.Qb(b):j};a.Gb=function(c,b){var d=new Image,e=b.url;d.addEventListener("load",function(){var b=a.l.texture[e];if(a.qa[c](e,
d)){b.status="loaded";for(var k;k=b.S.shift();)k(b.data);a.Q(c);a.Q("all")}else b.status="try",a.u(c,e)},o);d.src=e};a.Eb=function(c,b){var d=b.url;$.ajax({url:d,dataType:b.dataType,success:function(b,f){var k=a.l[c][d];if(f=="success")if(a.qa[c](d,b)){k.status="loaded";for(var h;h=k.S.shift();)h(k.data);a.Q(c);a.Q("all")}else k.status="try",a.u(c,d);else console.log("Error loading asset "+d)}})};a.Vb=function(){var a=this.b;if(this.d){a.clearColor(0,0,0,1);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);
a.enable(a.BLEND);a.disable(a.DEPTH_TEST);var b=a.O,d=a.G;a.viewport(0,0,b,d);this.M=mat4.create();if(this.ga=="2d")console.log("setting up 2d projection ("+b+","+d+")"),mat4.ortho(0,b,0,d,-1024,1024,this.M);else if(this.ga=="3d"){console.log("setting up 3d projection ("+b+","+d+")");var e=d/1.1566,a=mat4.perspective(60,b/d,0.5,1500),b=mat4.lookAt([b/2,d/2,e],[b/2,d/2,0],[0,1,0]);mat4.multiply(a,b,this.M)}else i("Invalid projection: "+this.ga)}};a.Tb=function(c){if(c.type==a.Block.g.SCENE)this.U=
c};a.Za=function(){var a=void 0;this.d?(a=this.b,a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)):(a=this.n,a.setTransform(1,0,0,1,0,0),a.fillRect(0,0,a.O,a.G));this.U&&this.U.la();!this.d&&this.Pa&&(a.fillRect(0,0,a.O,a.G),a.drawImage(this.ca,0,0));a=Date.now();this.R=a-this.fb;this.fb=a};a.eb=Date.now();a.wa=0;a.ya=0;a.ha=0;a.Oa=0;a.ec=function(){var c=Date.now();this.wa+=this.R;this.ya++;if(c-this.eb>1E3){var b=this.wa/this.ya;this.Oa+=b;this.ha++;if(this.va)this.va.textContent=b.toFixed(2);if(a.U&&
this.xb&&this.ha>5)_gaq.push(["_trackEvent","ChesterGL","renderTime-"+this.d,a.U.title,Math.floor(this.Oa/this.ha)]),this.Oa=this.ha=0;this.wa=this.ya=0;this.eb=c}};a.Jb=function(){$(this.canvas).mousedown(a.Nb);$(this.canvas).mousemove(a.Ob);$(this.canvas).mouseup(a.Pb)};a.Nb=function(c){for(var c=z(a.canvas,c),b=0,d=a.q.length;b<d;b++)a.q[b](c,a.p.Ra)};a.Ob=function(c){for(var c=z(a.canvas,c),b=0,d=a.q.length;b<d;b++)a.q[b](c,a.p.Sa)};a.Pb=function(c){for(var c=z(a.canvas,c),b=0,d=a.q.length;b<
d;b++)a.q[b](c,a.p.Ta)};a.Bb=function(a){this.q.indexOf(a)==-1&&this.q.push(a)};a.Sb=function(a){a=this.q.indexOf(a);a>0&&this.q.splice(a,1)};a.Ia=function(){a.Y||(g.ob(a.Ia,a.canvas),a.Za(),a.o.wb(a.R))};a.Wb=function(){a.Y?(a.Y=o,a.Ia()):a.Y=j};a.a(g,"ChesterGL",a);a.a(a,"useGoogleAnalytics",a.xb);a.a(a,"projection",a.ga);a.a(a,"webglMode",a.d);a.a(a,"usesOffscreenBuffer",a.Pa);a.a(a,"debugSpanId",a.Db);a.a(a,"update",a.update);a.a(a,"mouseEvents",a.p);a.a(a.p,"DOWN",a.p.Ra);a.a(a.p,"MOVE",a.p.Sa);
a.a(a.p,"UP",a.p.Ta);a.a(a,"setup",a.Ub);a.a(a,"canvasResized",a.Wa);a.a(a,"initShader",a.aa);a.a(a,"registerAssetHandler",a.Fa);a.a(a,"loadAsset",a.u);a.a(a,"assetsLoaded",a.Q);a.a(a,"getAsset",a.K);a.a(a,"setupPerspective",a.Vb);a.a(a,"setRunningScene",a.Tb);a.a(a,"drawScene",a.Za);a.a(a,"run",a.Ia);a.a(a,"togglePause",a.Wb);a.a(a,"addMouseHandler",a.Bb);a.a(a,"removeMouseHandler",a.Sb)})(window);(function(g){var a=g.ChesterGL;a.Block=function(c,b,d){this.type=b||a.Block.g.STANDALONE;if(d)this.parent=d;this.children=[];this.j=a.Block.k.DEFAULT;c&&(typeof c==="string"?(c=a.BlockFrames.za(c),this.N(c.c),this.z(c.frame)):this.z(c));this.type==a.Block.g.STANDALONE&&this.ia([1,1,1,1]);if(a.d&&this.type==a.Block.g.STANDALONE&&(!d||d.type!=a.Block.g.BLOCKGROUP))this.s=a.b.createBuffer(),this.m=new Float32Array(a.Block.BUFFER_SIZE);this.f=mat4.create();this.D=mat4.create();mat4.identity(this.f);this.oa=
[];this.pa=[]};a.Block.k={DEFAULT:0,TEXTURE:1};a.Block.ma=["default","texture"];a.Block.g={STANDALONE:0,BLOCKGROUP:1,SCENE:2,TMXBLOCK:3,PARTICLE:4};a.Block.na=36;a.Block.BUFFER_SIZE=36;a.Block.Qa=Math.PI/180;a.Block.bc=180/Math.PI;a.Block.yb=quat4.create([0,0,1,1]);a.Block.zb=r([0,0]);a.Block.prototype.title="";a.Block.prototype.f=l;a.Block.prototype.D=l;a.Block.prototype.X=j;a.Block.prototype.i=o;a.Block.prototype.L=o;a.Block.prototype.B=o;a.Block.prototype.sa=0;a.Block.prototype.s=l;a.Block.prototype.m=
l;a.Block.prototype.position=vec3.create();a.Block.prototype.r=l;a.Block.prototype.color=quat4.create([1,1,1,1]);a.Block.prototype.c=l;a.Block.prototype.opacity=1;a.Block.prototype.rotation=0;a.Block.prototype.scale=1;a.Block.prototype.update=l;a.Block.prototype.frame=l;a.Block.prototype.parent=l;a.Block.prototype.children=l;a.Block.prototype.oa=l;a.Block.prototype.pa=l;a.Block.prototype.P=o;a.Block.prototype.z=function(c){if(typeof c==="string")c=a.BlockFrames.za(c).frame;this.frame=quat4.create(c);
this.W([c[2],c[3]]);this.B=j};a.Block.prototype.W=function(a){this.r=r(a);this.B=j};a.Block.prototype.Na=function(a){this.scale=a;this.i=j};a.Block.prototype.ia=function(a){this.color=quat4.create(a);this.L=j};a.Block.prototype.N=function(c){this.c=c;this.j=a.Block.k.TEXTURE;var b=this;a.u("texture",c,function(a){b.r||b.W([a.width,a.height]);b.frame||b.z([0,0,a.width,a.height])})};a.Block.prototype.moveTo=function(c,b){if(b){var d=new a.MoveToAction(this,b,c);a.o.qb(d)}else this.position=vec3.create(c),
this.i=j};a.Block.prototype.moveBy=function(a){vec3.add(this.position,a);this.i=j};a.Block.prototype.Ha=function(c){this.rotation=(a.d?-1:1)*c*a.Block.Qa;this.i=j};a.Block.prototype.Ga=function(c){this.rotation+=(a.d?-1:1)*c*a.Block.Qa;this.i=j};a.Block.prototype.A=function(a){a.parent&&i("can't add a block twice!");this.P?this.oa.push(a):(this.children.push(a),a.parent=this)};a.Block.prototype.removeChild=function(a){(!a.parent||a.parent!=this)&&i("not our child!");this.P?this.pa.push(a):(a=this.children.indexOf(a),
a>=0&&this.children.splice(a,1))};a.Block.prototype.transform=function(){var c=a.b;if(this.i||this.parent&&this.parent.i){mat4.identity(this.f);mat4.translate(this.f,this.position);mat4.rotate(this.f,this.rotation,[0,0,1]);mat4.scale(this.f,[this.scale,this.scale,1]);var b=this.parent?this.parent.f:l;b&&mat4.multiply(b,this.f,this.f)}if(this.type!=a.Block.g.BLOCKGROUP){var b=this.m,d=this.parent&&this.parent.type==a.Block.g.BLOCKGROUP;if(a.d){!d&&(this.B||this.L)&&c.bindBuffer(c.ARRAY_BUFFER,this.s);
if(this.B||d&&this.i){var e=9,f=this.r[0]*0.5,k=this.r[1]*0.5,h=this.sa*a.Block.BUFFER_SIZE,g=this.position[2];if(d){var p=[f,k,0],n=[-f,k,0],m=[f,-k,0],f=[-f,-k,0];mat4.multiplyVec3(this.f,p);mat4.multiplyVec3(this.f,n);mat4.multiplyVec3(this.f,f);mat4.multiplyVec3(this.f,m);b[h]=f[0];b[h+1]=f[1];b[h+2]=g;b[h+e]=n[0];b[h+1+e]=n[1];b[h+2+e]=g;b[h+2*e]=m[0];b[h+1+2*e]=m[1];b[h+2+2*e]=g;b[h+3*e]=p[0];b[h+1+3*e]=p[1];b[h+2+3*e]=g}else b[h]=-f,b[h+1]=-k,b[h+2]=0,b[h+e]=-f,b[h+1+e]=k,b[h+2+e]=0,b[h+2*
e]=f,b[h+1+2*e]=-k,b[h+2+2*e]=0,b[h+3*e]=f,b[h+1+3*e]=k,b[h+2+3*e]=0;if(this.j==a.Block.k.TEXTURE)g=a.K("texture",this.c),n=g.width,m=g.height,g=this.frame[0]/n,p=this.frame[1]/m,n=this.frame[2]/n,m=this.frame[3]/m,h+=3,b[h]=g,b[h+1]=p,b[h+e]=g,b[h+1+e]=p+m,b[h+2*e]=g+n,b[h+1+2*e]=p,b[h+3*e]=g+n,b[h+1+3*e]=p+m}if(this.L){h=5+this.sa*a.Block.BUFFER_SIZE;g=this.color;p=this.opacity;for(n=0;n<4;n++)b[h+e*n]=g[0]*p,b[h+1+e*n]=g[1]*p,b[h+2+e*n]=g[2]*p,b[h+3+e*n]=g[3]*p}a.d&&!d&&(this.B||this.L)&&c.bufferData(c.ARRAY_BUFFER,
this.m,c.STATIC_DRAW)}}};a.Block.prototype.la=function(){this.P=j;this.update&&this.update(a.R);if(this.X){this.transform();for(var c=this.children,b=c.length,d=0;d<b;d++)c[d].la();(!this.parent||this.parent.type!=a.Block.g.BLOCKGROUP)&&this.T();for(this.P=this.B=this.L=this.i=o;c=this.oa.shift();)this.A(c);for(;c=this.pa.shift();)this.removeChild(c)}else this.P=o};a.Block.prototype.T=function(){this.type==a.Block.g.BLOCKGROUP&&i("Cannot call render on a BlockGroup block!");if(this.type!=a.Block.g.SCENE)if(a.d){var c=
a.b,b=a.V(a.Block.ma[this.j]);c.bindBuffer(c.ARRAY_BUFFER,this.s);var d=a.Block.na;c.vertexAttribPointer(b.e.vertexPositionAttribute,3,c.FLOAT,o,d,0);c.vertexAttribPointer(b.e.vertexColorAttribute,4,c.FLOAT,o,d,20);if(this.j!=a.Block.k.DEFAULT&&this.j==a.Block.k.TEXTURE){var e=a.K("texture",this.c);c.vertexAttribPointer(b.e.textureCoordAttribute,2,c.FLOAT,o,d,12);c.activeTexture(c.TEXTURE0);c.bindTexture(c.TEXTURE_2D,e.ja);c.uniform1i(b.Ka,0);c.cc=j}(this.i||this.parent&&this.parent.i)&&mat4.multiply(a.M,
this.f,this.D);c.uniformMatrix4fv(b.F,o,this.D);c.drawArrays(c.TRIANGLE_STRIP,0,4)}else if(c=a.n,this.j==a.Block.k.TEXTURE){b=this.f;e=a.K("texture",this.c);c.globalAlpha=this.opacity;c.setTransform(b[0],b[1],b[4],b[5],b[12],c.G-b[13]);var b=this.r[0],d=this.r[1],f=this.frame;c.drawImage(e,f[0],e.height-(f[1]+d),f[2],f[3],-b/2,-d/2,b,d)}};a.a(a,"Block",a.Block);a.a(a.Block,"FullFrame",a.Block.yb);a.a(a.Block,"SizeZero",a.Block.zb);a.a(a.Block,"TYPE",a.Block.g);a.a(a.Block,"PROGRAM",a.Block.k);a.a(a.Block,
"PROGRAM_NAME",a.Block.ma);a.a(a.Block.prototype,"visible",a.Block.prototype.X);a.a(a.Block.prototype,"position",a.Block.prototype.position);a.a(a.Block.prototype,"contentSize",a.Block.prototype.r);a.a(a.Block.prototype,"color",a.Block.prototype.color);a.a(a.Block.prototype,"texture",a.Block.prototype.c);a.a(a.Block.prototype,"opacity",a.Block.prototype.opacity);a.a(a.Block.prototype,"rotation",a.Block.prototype.rotation);a.a(a.Block.prototype,"scale",a.Block.prototype.scale);a.a(a.Block.prototype,
"update",a.Block.prototype.update);a.a(a.Block.prototype,"frame",a.Block.prototype.frame);a.a(a.Block.prototype,"parent",a.Block.prototype.parent);a.a(a.Block.prototype,"children",a.Block.prototype.children);a.a(a.Block.prototype,"setFrame",a.Block.prototype.z);a.a(a.Block.prototype,"setContentSize",a.Block.prototype.W);a.a(a.Block.prototype,"setScale",a.Block.prototype.Na);a.a(a.Block.prototype,"setColor",a.Block.prototype.ia);a.a(a.Block.prototype,"setTexture",a.Block.prototype.N);a.a(a.Block.prototype,
"moveTo",a.Block.prototype.moveTo);a.a(a.Block.prototype,"moveBy",a.Block.prototype.moveBy);a.a(a.Block.prototype,"rotateTo",a.Block.prototype.Ha);a.a(a.Block.prototype,"rotateBy",a.Block.prototype.Ga);a.a(a.Block.prototype,"addChild",a.Block.prototype.A);a.a(a.Block.prototype,"removeChild",a.Block.prototype.removeChild)})(window);(function(g){var a=g.ChesterGL;a.BlockGroup=function(c,b){a.d||i("BlockGroup only works on WebGL mode");a.Block.call(this,l,a.Block.g.BLOCKGROUP);c?(this.c=c,this.j=a.Block.k.TEXTURE):this.j=a.Block.k.DEFAULT;this.ba=b||10;this.Cb()};a.BlockGroup.prototype=Object.create(a.Block.prototype);a.BlockGroup.prototype.ba=0;a.BlockGroup.prototype.Ca=o;a.BlockGroup.prototype.Aa=l;a.BlockGroup.prototype.t=l;a.BlockGroup.prototype.Cb=function(){var c=a.b;this.s=c.createBuffer();this.m=new Float32Array(a.Block.na*
this.ba);this.Aa=c.createBuffer();this.t=new Uint16Array(6*this.ba)};a.BlockGroup.prototype.Xa=function(c){c=new a.Block(c,a.Block.g.STANDALONE,this);this.c&&c.N(this.c);return c};a.BlockGroup.prototype.A=function(a){this.children.length>=this.ba&&i("Error: too many children - Make the initial size of the BlockGroup larger");a.parent!=this&&i("Invalid child: can only add children created with BlockGroup.create");this.c?this.c!=a.c&&i("Invalid child: only can add child with the same texture"):this.c=
a.c;this.children.push(a);a.sa=this.children.length-1;a.m=this.m;this.Ca=j};a.BlockGroup.prototype.Rb=function(){for(var c=(this.t[-1]||-1)+1,b=Math.max(this.children.length,1),d=0;d<b;d++){var e=d*6;this.t[e+0]=c;this.t[e+1]=c+1;this.t[e+2]=c+2;this.t[e+3]=c+2;this.t[e+4]=c+1;this.t[e+5]=c+3;c+=4}c=a.b;c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,this.Aa);c.bufferData(c.ELEMENT_ARRAY_BUFFER,this.t,c.STATIC_DRAW)};a.BlockGroup.prototype.la=function(){this.update&&this.update(a.R);if(this.X){this.transform();
for(var c=this.children,b=c.length,d=0;d<b;d++)c[d].la();c=a.b;c.bindBuffer(c.ARRAY_BUFFER,this.s);c.bufferData(c.ARRAY_BUFFER,this.m,c.STATIC_DRAW);if(this.Ca)this.Rb(),this.Ca=o;this.T();this.B=this.L=this.i=o}};a.BlockGroup.prototype.T=function(){var c=a.b,b=a.V(a.Block.ma[this.j]),d=this.children.length,e=a.Block.na;c.bindBuffer(c.ARRAY_BUFFER,this.s);c.vertexAttribPointer(b.e.vertexPositionAttribute,3,c.FLOAT,o,e,0);if(this.j!=a.Block.k.DEFAULT&&this.j==a.Block.k.TEXTURE){var f=a.K("texture",
this.c);c.vertexAttribPointer(b.e.textureCoordAttribute,2,c.FLOAT,o,e,12);c.activeTexture(c.TEXTURE0);c.bindTexture(c.TEXTURE_2D,f.ja);c.uniform1i(b.Ka,0)}c.vertexAttribPointer(b.e.vertexColorAttribute,4,c.FLOAT,o,e,20);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,this.Aa);mat4.multiply(a.M,this.f,this.D);c.uniformMatrix4fv(b.F,o,this.D);c.drawElements(c.TRIANGLES,d*6,c.UNSIGNED_SHORT,0)};a.a(a,"BlockGroup",a.BlockGroup);a.a(a.BlockGroup.prototype,"visible",a.BlockGroup.prototype.X);a.a(a.BlockGroup.prototype,
"position",a.BlockGroup.prototype.position);a.a(a.BlockGroup.prototype,"contentSize",a.BlockGroup.prototype.r);a.a(a.BlockGroup.prototype,"color",a.BlockGroup.prototype.color);a.a(a.BlockGroup.prototype,"texture",a.BlockGroup.prototype.c);a.a(a.BlockGroup.prototype,"opacity",a.BlockGroup.prototype.opacity);a.a(a.BlockGroup.prototype,"rotation",a.BlockGroup.prototype.rotation);a.a(a.BlockGroup.prototype,"scale",a.BlockGroup.prototype.scale);a.a(a.BlockGroup.prototype,"update",a.BlockGroup.prototype.update);
a.a(a.BlockGroup.prototype,"frame",a.BlockGroup.prototype.frame);a.a(a.BlockGroup.prototype,"parent",a.BlockGroup.prototype.parent);a.a(a.BlockGroup.prototype,"children",a.BlockGroup.prototype.children);a.a(a.BlockGroup.prototype,"setFrame",a.BlockGroup.prototype.z);a.a(a.BlockGroup.prototype,"setContentSize",a.BlockGroup.prototype.W);a.a(a.BlockGroup.prototype,"setScale",a.BlockGroup.prototype.Na);a.a(a.BlockGroup.prototype,"setColor",a.BlockGroup.prototype.ia);a.a(a.BlockGroup.prototype,"setTexture",
a.BlockGroup.prototype.N);a.a(a.BlockGroup.prototype,"moveTo",a.BlockGroup.prototype.moveTo);a.a(a.BlockGroup.prototype,"moveBy",a.BlockGroup.prototype.moveBy);a.a(a.BlockGroup.prototype,"rotateTo",a.BlockGroup.prototype.Ha);a.a(a.BlockGroup.prototype,"rotateBy",a.BlockGroup.prototype.Ga);a.a(a.BlockGroup.prototype,"addChild",a.BlockGroup.prototype.A);a.a(a.BlockGroup.prototype,"removeChild",a.BlockGroup.prototype.removeChild);a.a(a.BlockGroup.prototype,"createBlock",a.BlockGroup.prototype.Xa)})(window);(function(g){var a=g.ChesterGL,c={frames:{}};c.Lb=function(b){if(b.meta&&b.meta.version=="1.0"){var d=b.meta.image;a.u("texture",d,function(a){var a=a.height,f=b.frames,g;for(g in f){var h=f[g],A={frame:{},c:""};A.frame=quat4.create([h.frame.x,a-(h.frame.y+h.frame.h),h.frame.w,h.frame.h]);A.c=d;c.frames[g]=A}})}else i("Unkown json data")};c.za=function(a){return c.frames[a]};c.Kb=function(a){console.log("loadFrames: will fetch "+a);$.ajax({url:a,async:o,dataType:"json",success:function(a,b){b=="success"&&
c.Lb(a)}})};a.a(a,"BlockFrames",c);a.a(c,"getFrame",c.za);a.a(c,"loadFrames",c.Kb)})(window);(function(g){var a=g.ChesterGL;a.TMXBlock=function(c){(c=a.TMXBlock.kb[c])||i("Invalid map - make sure you call loadTMX first");a.Block.call(this,l,a.Block.g.TMXBLOCK);for(var b=0;b<c.layers.length;b++){for(var d=c.layers[b],e=a.d?new a.BlockGroup(c.texture,d.blocks.length):new a.Block,f=0;f<d.blocks.length;f++){var g=d.blocks[f],h=void 0;a.d?h=e.Xa(g.frame):(h=new a.Block(g.frame),h.N(c.texture));h.moveTo(g.position);e.A(h)}this.A(e)}};a.TMXBlock.prototype=Object.create(a.Block.prototype);a.TMXBlock.prototype.T=
function(){};a.TMXBlock.kb={};a.TMXBlock.Mb=function(c){a.u("tmx",{path:c,dataType:"xml"},function(b){var d={},b=$(b).find("map"),e=b.find("tileset").first(),f=b.attr("orientation");if(e){d.tileSize=r([parseInt(e.attr("tilewidth"),10),parseInt(e.attr("tileheight"),10)]);d.mapTileSize=r([parseInt(b.attr("tilewidth"),10),parseInt(b.attr("tileheight"),10)]);e.attr("spacing")&&(d.spacing=parseInt(e.attr("spacing"),10));e.attr("margin")&&(d.margin=parseInt(e.attr("margin"),10));var e=e.find("image").first(),
g=r([parseInt(e.attr("width"),10),parseInt(e.attr("height"),10)]);d.texture=e.attr("source");a.u("texture",d.texture);d.layers=[];b.find("layer").each(function(a,b){var c={blocks:[]},e=r([parseInt($(b).attr("width"),10),parseInt($(b).attr("height"),10)]),m=$(b).find("data").first();if(m){(m.attr("encoding")!="base64"||m.attr("compression"))&&i("Invalid TMX Data");for(var m=m.text().trim(),m=base64.decode(m),s=0,t=0;t<e[1];t++)for(var u=0;u<e[0];u++){var w=((m.charCodeAt(s+3)&255)<<24|(m.charCodeAt(s+
2)&255)<<16|(m.charCodeAt(s+1)&255)<<8|m.charCodeAt(s+0)&255)-1,B={},x=d.margin||0,v=d.spacing||0,q=d.tileSize,y=d.mapTileSize,E=parseInt((g[0]-x*2+v)/(q[0]+v),10),w=quat4.create([w%E*(q[0]+v)+x,g[1]-q[1]-x-v-parseInt(w/E,10)*(q[1]+v)+x,q[0],q[1]]);B.frame=w;var C,D;f=="orthogonal"?(C=u*y[0]+q[0]/2,D=(e[1]-t-1)*y[1]+q[1]/2):f=="isometric"?(C=y[0]/2*(e[0]+u-t-1)+q[0]/2,D=y[1]/2*(e[1]*2-u-t-2)+q[1]/2):i("Invalid orientation");B.position=[C,D,0];c.blocks.push(B);s+=4}}else i("No data for layer!");d.layers.push(c)})}a.TMXBlock.kb[c]=
d})};a.Fa("tmx",function(c,b){console.log("tmx loaded: "+c);a.l.tmx[c].data=b;return j});a.a(a,"TMXBlock",a.TMXBlock);a.a(a.TMXBlock,"loadTMX",a.TMXBlock.Mb)})(window);(function(g){var a=g.ChesterGL;a.Action=function(a,d){this.ua=a;this.ka=d*1E3;this.I=0};a.Action.prototype.ua=l;a.Action.prototype.ka=0;a.Action.prototype.I=0;a.Action.prototype.J=o;a.Action.prototype.update=function(a){this.I+=a;if(this.ka>0&&this.I>=this.ka)this.J=j};a.MoveToAction=function(b,d,c){a.Action.call(this,b,d);this.xa=vec3.create(c);this.tb=vec3.create(b.position)};a.MoveToAction.prototype=Object.create(a.Action.prototype);a.MoveToAction.prototype.xa=l;a.MoveToAction.prototype.tb=l;var c=
vec3.create();a.MoveToAction.prototype.update=function(b){a.Action.prototype.update.call(this,b);b=this.ua;if(this.J)b.moveTo(this.xa);else{var d=Math.min(1,this.I/this.ka);vec3.lerp(this.tb,this.xa,d,c);b.moveTo(c)}};a.AnimateAction=function(b,d,c,f){this.delay=d*1E3;d=this.delay*c.length;f==j&&(d=-1);a.Action.call(this,b,d);this.rb=f==j;this.frames=c.slice(0)};a.AnimateAction.prototype=Object.create(a.Action.prototype);a.AnimateAction.prototype.H=0;a.AnimateAction.prototype.delay=0;a.AnimateAction.prototype.frames=
l;a.AnimateAction.prototype.rb=o;a.AnimateAction.prototype.update=function(b){a.Action.prototype.update.call(this,b);b=this.ua;if(this.J)this.H=this.frames.length-1,this.J=j,b.z(this.frames[this.H]);else if(this.I>=this.delay*this.H&&(b.z(this.frames[this.H++]),this.H==this.frames.length))this.rb?this.I=this.H=0:this.J=j};a.o={};a.o.La=[];a.o.qb=function(a){this.La.push(a)};a.o.wb=function(a){for(var c=0,e=this.La.length,c=0;c<e;c++){var f=this.La[c];!f.J&&f.update(a)}};a.a(a,"ActionManager",a.o);
a.a(a.o,"scheduleAction",a.o.qb);a.a(a.o,"tick",a.o.wb);a.a(a,"MoveToAction",a.MoveToAction);a.a(a,"AnimateAction",a.AnimateAction)})(window);(function(g){var a=g.ChesterGL;a.ParticleSystem=function(b){a.Block.call(this,l,a.Block.g.ac);var c=this;a.u("texture",b.texture,function(){c.hb(b)})};a.ParticleSystem.Ua=o;a.ParticleSystem.jb=function(){a.aa("particles",function(b){var c=a.b;b.F=c.getUniformLocation(b,"uMVPMatrix");b.Xb=c.getUniformLocation(b,"uSampler");b.$b=c.getUniformLocation(b,"u_time");b.Zb=c.getUniformLocation(b,"u_startColor");b.Yb=c.getUniformLocation(b,"u_endColor");b.e={a_startPosition:c.getAttribLocation(b,"a_startPosition"),
a_lifetime:c.getAttribLocation(b,"a_lifetime"),a_startTime:c.getAttribLocation(b,"a_startTime"),a_startSize:c.getAttribLocation(b,"a_startSize"),a_endSize:c.getAttribLocation(b,"a_endSize"),a_speed:c.getAttribLocation(b,"a_speed")};b=c.getError();b!=0&&console.log("gl error: "+b)});a.ParticleSystem.Ua=j};a.ParticleSystem.prototype=Object.create(a.Block.prototype);a.ParticleSystem.prototype.Ja=j;a.ParticleSystem.prototype.lb=l;a.ParticleSystem.prototype.$a=0;a.ParticleSystem.prototype.$=0;a.ParticleSystem.prototype.v=
0;a.ParticleSystem.prototype.C=0;a.ParticleSystem.prototype.duration=0;a.ParticleSystem.prototype.Da=0;a.ParticleSystem.prototype.gb=0;a.ParticleSystem.prototype.sb=l;a.ParticleSystem.prototype.fa=l;a.ParticleSystem.prototype.ab=l;a.ParticleSystem.prototype.da=l;a.ParticleSystem.prototype.ea=l;a.ParticleSystem.prototype.ub=0;a.ParticleSystem.prototype.vb=0;a.ParticleSystem.prototype.bb=0;a.ParticleSystem.prototype.cb=0;a.ParticleSystem.prototype.Ea=o;a.ParticleSystem.prototype.elapsedTime=0;a.ParticleSystem.prototype.ta=
["SRC_ALPHA","ONE_MINUS_SRC_ALPHA"];a.ParticleSystem.prototype.hb=function(b){this.j=-1;a.ParticleSystem.Ua||a.ParticleSystem.jb();this.lb=b.texture;this.C=b.maxParticles;this.duration=parseFloat(b.duration)*1E3;this.Da=parseFloat(b.lifetime)*1E3;this.gb=parseFloat(b.lifetimeVariance)*1E3;this.sb=quat4.create(b.startColor);this.fa=vec3.create(b.positionVariance);this.ab=quat4.create(b.endColor);this.da=vec3.create(b.speed);this.ea=vec3.create(b.speedVariance);this.ub=parseFloat(b.startSize);this.vb=
parseFloat(b.startSizeVariance);this.bb=parseFloat(b.endSize);this.cb=parseFloat(b.endSizeVariance);this.elapsedTime=0;this.ta=b.blendOptions.slice(0);this.Ja=j;this.s=a.b.createBuffer();this.m=new Float32Array(this.C*10);this.pb()};a.ParticleSystem.prototype.Va=function(){this.Ba(this.v,Math.abs(this.Da+this.gb*(Math.random()*2-1)),this.elapsedTime);this.v++;this.Ea=j};a.ParticleSystem.prototype.Ba=function(a,c,e){var f=this.m;f[a*10+0]=c||-1;f[a*10+1]=e||0;f[a*10+2]=this.ub+this.vb*(Math.random()*
2-1);f[a*10+3]=this.bb+this.cb*(Math.random()*2-1);f[a*10+4]=this.da[0]+this.ea[0]*(Math.random()*2-1);f[a*10+5]=this.da[1]+this.ea[1]*(Math.random()*2-1);f[a*10+6]=this.da[2]+this.ea[2]*(Math.random()*2-1);f[a*10+7]=(Math.random()*2-1)*this.fa[0];f[a*10+8]=(Math.random()*2-1)*this.fa[1];f[a*10+9]=(Math.random()*2-1)*this.fa[2]};a.ParticleSystem.prototype.pb=function(){for(var b=a.V("particles"),c=a.b,e=0;e<this.C;e++)this.Ba(e);c.uniform4fv(b.Zb,this.sb);c.uniform4fv(b.Yb,this.ab);c.uniform1i(b.Xb,
0);this.Ma();this.v=this.$=0;this.$a=this.C/Math.abs(this.Da)};a.ParticleSystem.prototype.Ma=function(){var b=a.b;b.bindBuffer(b.ARRAY_BUFFER,this.s);b.bufferData(b.ARRAY_BUFFER,this.m,b.STATIC_DRAW)};var c=new Float32Array(10);a.ParticleSystem.prototype.update=function(b){if(a.V("particles")){this.elapsedTime+=b;var d=1/this.$a;for(this.$+=b;this.v<this.C&&this.$>d&&this.Ja;)this.Va(),this.$-=d;for(b=0;b<this.C;b++){var d=this.m,e=b*10;if(d[e]>0&&d[e]+d[e+1]<=this.elapsedTime&&b!=this.v-1){var f=
d.subarray(e,e+10);c.set(f);c[0]=-1;f=d.subarray(e+10,this.v*10);d.set(f,e);d.set(c,(this.v-1)*10);this.v--}}if(this.duration>0&&this.elapsedTime>this.duration)this.Ja=o}};a.ParticleSystem.prototype.T=function(){var b=a.V("particles");if(b){var c=a.b,e=a.K("texture",this.lb);c.enable(c.BLEND);c.blendFunc(c[this.ta[0]],c[this.ta[1]]);if(this.Ea)this.Ma(),this.Ea=o;c.uniform1f(b.$b,this.elapsedTime);c.activeTexture(c.TEXTURE0);c.bindTexture(c.TEXTURE_2D,e.ja);c.bindBuffer(c.ARRAY_BUFFER,this.s);c.vertexAttribPointer(b.e.a_lifetime,
3,c.FLOAT,o,40,0);c.vertexAttribPointer(b.e.a_startTime,3,c.FLOAT,o,40,4);c.vertexAttribPointer(b.e.a_startSize,3,c.FLOAT,o,40,8);c.vertexAttribPointer(b.e.a_endSize,3,c.FLOAT,o,40,12);c.vertexAttribPointer(b.e.a_speed,3,c.FLOAT,o,40,16);c.vertexAttribPointer(b.e.a_startPosition,3,c.FLOAT,o,40,28);(this.i||this.parent&&this.parent.i)&&mat4.multiply(a.M,this.f,this.D);c.uniformMatrix4fv(b.F,o,this.D);c.drawArrays(c.POINTS,0,this.C)}};a.a(a,"ParticleSystem",a.ParticleSystem);a.a(a.ParticleSystem.prototype,
"visible",a.ParticleSystem.prototype.X);a.a(a.ParticleSystem.prototype,"position",a.ParticleSystem.prototype.position);a.a(a.ParticleSystem.prototype,"contentSize",a.ParticleSystem.prototype.r);a.a(a.ParticleSystem.prototype,"color",a.ParticleSystem.prototype.color);a.a(a.ParticleSystem.prototype,"texture",a.ParticleSystem.prototype.c);a.a(a.ParticleSystem.prototype,"opacity",a.ParticleSystem.prototype.opacity);a.a(a.ParticleSystem.prototype,"rotation",a.ParticleSystem.prototype.rotation);a.a(a.ParticleSystem.prototype,
"scale",a.ParticleSystem.prototype.scale);a.a(a.ParticleSystem.prototype,"update",a.ParticleSystem.prototype.update);a.a(a.ParticleSystem.prototype,"frame",a.ParticleSystem.prototype.frame);a.a(a.ParticleSystem.prototype,"parent",a.ParticleSystem.prototype.parent);a.a(a.ParticleSystem.prototype,"children",a.ParticleSystem.prototype.children);a.a(a.ParticleSystem,"loadShaders",a.ParticleSystem.jb);a.a(a.ParticleSystem.prototype,"setFrame",a.ParticleSystem.prototype.z);a.a(a.ParticleSystem.prototype,
"setContentSize",a.ParticleSystem.prototype.W);a.a(a.ParticleSystem.prototype,"setScale",a.ParticleSystem.prototype.Na);a.a(a.ParticleSystem.prototype,"setColor",a.ParticleSystem.prototype.ia);a.a(a.ParticleSystem.prototype,"setTexture",a.ParticleSystem.prototype.N);a.a(a.ParticleSystem.prototype,"moveTo",a.ParticleSystem.prototype.moveTo);a.a(a.ParticleSystem.prototype,"moveBy",a.ParticleSystem.prototype.moveBy);a.a(a.ParticleSystem.prototype,"rotateTo",a.ParticleSystem.prototype.Ha);a.a(a.ParticleSystem.prototype,
"rotateBy",a.ParticleSystem.prototype.Ga);a.a(a.ParticleSystem.prototype,"addChild",a.ParticleSystem.prototype.A);a.a(a.ParticleSystem.prototype,"removeChild",a.ParticleSystem.prototype.removeChild);a.a(a.ParticleSystem.prototype,"loadProperties",a.ParticleSystem.prototype.hb);a.a(a.ParticleSystem.prototype,"addParticle",a.ParticleSystem.prototype.Va);a.a(a.ParticleSystem.prototype,"initParticle",a.ParticleSystem.prototype.Ba);a.a(a.ParticleSystem.prototype,"resetParticles",a.ParticleSystem.prototype.pb);
a.a(a.ParticleSystem.prototype,"sendParticleData",a.ParticleSystem.prototype.Ma)})(window);
