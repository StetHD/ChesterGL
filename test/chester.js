function g(a){throw a;}var aa=void 0,i=!0,j=null,k=!1,m,n=this;Math.floor(2147483648*Math.random()).toString(36);function t(a,b){var c=a.split("."),e=n;!(c[0]in e)&&e.execScript&&e.execScript("var "+c[0]);for(var d;c.length&&(d=c.shift());)!c.length&&b!==aa?e[d]=b:e=e[d]?e[d]:e[d]={}}function y(a,b){function c(){}c.prototype=b.prototype;a.Ya=b.prototype;a.prototype=new c};function ba(a,b){this.x=a!==aa?a:0;this.y=b!==aa?b:0}ba.prototype.toString=function(){return"("+this.x+", "+this.y+")"};function ca(a,b){this.x=a;this.y=b}y(ca,ba);ca.prototype.scale=function(a){this.x*=a;this.y*=a;return this};var da,A;HTMLCanvasElement.Ea=new ca(0,0);function ea(a){var b=C,c=HTMLCanvasElement.Ea;c.x=0;c.y=0;var e=$(b).offset(),b=$(b).height();c.x=a.pageX-e.left;c.y=b-(a.pageY-e.top);return c}window.La=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)};t("requestAnimationFrame",window.requestAnimationFrame);
function fa(a,b){console.log(WebGLDebugUtils.glEnumToString(a)+" was caused by call to "+b)}var ga={useGoogleAnalytics:k,projection:"3d",webglMode:i,usesOffscreenBuffer:k,debugSpanId:"debug-info"},ha="3d",F=i,ia=k,ja=k,I=j,ka=k,la={},ma=j,K=j,na=j,C=j,oa=k,L={},pa={},qa={},ra={},sa=Date.now(),ta=0,ua=j,M=[];function va(a){var b=la[a],c=I;if(a!=ma){ma=a;c.validateProgram(b);c.useProgram(b);for(var e in b.a)c.enableVertexAttribArray(b.a[e])}return b}function wa(){var a=C;I.M=a.width;I.H=a.height}
function xa(){var a=I;ya("default",function(b){b.o=a.getUniformLocation(b,"uMVPMatrix");b.a={vertexPositionAttribute:a.getAttribLocation(b,"aVertexPosition"),vertexColorAttribute:a.getAttribLocation(b,"aVertexColor")};b.mvpMatrixUniform=b.o;b.attribs=b.a});ya("texture",function(b){b.o=a.getUniformLocation(b,"uMVPMatrix");b.ha=a.getUniformLocation(b,"uSampler");b.a={vertexColorAttribute:a.getAttribLocation(b,"aVertexColor"),textureCoordAttribute:a.getAttribLocation(b,"aTextureCoord"),vertexPositionAttribute:a.getAttribLocation(b,
"aVertexPosition")};b.mvpMatrixUniform=b.o;b.samplerUniform=b.ha;b.attribs=b.a})}
function ya(a,b){var c=I,e=za(a,"frag"),d=za(a,"vert"),f=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(f,e);c.compileShader(f);c.getShaderParameter(f,c.COMPILE_STATUS)?(e=c.createShader(c.VERTEX_SHADER),c.shaderSource(e,d),c.compileShader(e),c.getShaderParameter(e,c.COMPILE_STATUS)?(c=I,d=c.createProgram(),c.attachShader(d,f),c.attachShader(d,e),c.linkProgram(d),c.getProgramParameter(d,c.LINK_STATUS)||console.log("problem linking shader"),la[a]=d,b&&b(d)):console.log("problem compiling vertex shader "+
a+"("+c.getShaderInfoLog(e)+"):\n"+d)):console.log("problem compiling fragment shader "+a+"("+c.getShaderInfoLog(f)+"):\n"+e)}function za(a,b){var c="";$.ajax({url:"shaders/"+a+"."+b,async:k,type:"GET",success:function(a,b){"success"==b?c=a:console.log("error getting the shader data")}});return c}
function N(a,b,c){var e=aa;"object"==typeof b&&(e=b.dataType,b=b.path);L[a]||(L[a]={});var d=L[a];if(d[b])if("loading"==d[b].status)c&&d[b].K.push(c);else if("loaded"==d[b].status)c&&c(d[b].data);else{if("try"==d[b].status){d[b].status="loading";if(qa[a])qa[a](a,{url:b,dataType:e});else qa["default"](a,{url:b,dataType:e});c&&d[b].K.push(c)}}else d[b]={data:j,status:"try",K:[]},c&&d[b].K.push(c),N(a,{path:b,dataType:e})}
function Aa(a,b){var c=ra[a];c||(ra[a]=[],c=ra[a]);b&&c.push(b);var e=i;if("all"==a)for(var d in L){var f=L[d],h;for(h in f)if("loaded"!=f[h].status){e=k;break}if(!e)break}else for(h in f=L[a],f)if("loaded"!=f[h].status){e=k;break}if(e)for(;e=c.shift();)e()}function Ja(a,b){return b?L[a][b].data:j}
function Ka(a,b){F&&(b.T=I.createTexture());L.texture[a].data=b;var c;if(F){c=I;var e=i;try{var d=0;c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,1);c.activeTexture(c.TEXTURE0);c.bindTexture(c.TEXTURE_2D,b.T);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,b);d=c.getError();0!=d&&(console.log("gl error "+d),e=k);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR);c.bindTexture(c.TEXTURE_2D,j)}catch(f){console.log("got some error: "+
f),e=k}c=e}else c=i;return c}function Ma(a,b){var c=new Image,e=b.url;c.addEventListener("load",function(){var b=L.texture[e];if(pa[a](e,c)){b.status="loaded";for(var f;f=b.K.shift();)f(b.data);Aa(a);Aa("all")}else b.status="try",N(a,e)},k);c.src=e}
function Na(a,b){var c=b.url;$.ajax({url:c,dataType:b.dataType,success:function(b,d){var f=L[a][c];if("success"==d){var h=pa[a];h||g("No handler for asset of type "+a);if(h(c,b)){for(f.status="loaded";h=f.K.shift();)h(f.data);Aa(a);Aa("all")}else f.status="try",N(a,c)}else console.log("Error loading asset "+c)}})}
function Oa(){var a=aa;F?(a=I,a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)):(a=A,a.setTransform(1,0,0,1,0,0),a.fillRect(0,0,a.M,a.H));na&&na.I();!F&&ia&&(a.fillRect(0,0,a.M,a.H),a.drawImage(da,0,0));a=Date.now();ta=a-sa;sa=a}var Pa=Date.now(),Qa=0,Ra=0,Sa=0,Ta=0,Ua=new Float32Array(3);function Va(a){var a=ea(a),b=0,c=M.length;for(Ua.set([a.x,a.y,0]);b<c;b++)M[b](Ua,0)}function Wa(a){var a=ea(a),b=0,c=M.length;for(Ua.set([a.x,a.y,0]);b<c;b++)M[b](Ua,1)}
function Xa(a){var a=ea(a),b=0,c=M.length;for(Ua.set([a.x,a.y,0]);b<c;b++)M[b](Ua,2)}function Ya(){if(!ka){window.La(Ya,C);Oa();O.Pa();var a=Date.now();Qa+=ta;Ra++;if(1E3<a-Pa){var b=Qa/Ra;Ta+=b;Sa++;ua&&(ua.textContent=b.toFixed(2));na&&ja&&5<Sa&&(_gaq.push(["_trackEvent","chesterGL","renderTime-"+F+"-0.2.1",na.title,1*(Ta/Sa)]),Ta=Sa=0);Qa=Ra=0;Pa=a}}}t("chesterGL.version","0.2.1");t("chesterGL.settings",ga);t("chesterGL.mouseEvents",{Ua:0,Va:1,Wa:2});t("chesterGL.mouseEvents.DOWN",0);
t("chesterGL.mouseEvents.MOVE",1);t("chesterGL.mouseEvents.UP",2);t("chesterGL.viewportSize",function(){return new P(I.M,I.H)});
t("chesterGL.setup",function(a){a=document.getElementById(a);ha=ga.projection;F=ga.webglMode;ja=ga.useGoogleAnalytics;ia=ga.usesOffscreenBuffer;try{if(C=a,F&&(I=a.getContext("experimental-webgl",{alpha:k,antialias:k}))&&window.WebGLDebugUtils)console.log("installing debug context"),I=WebGLDebugUtils.makeDebugContext(I,fa)}catch(b){console.log("ERROR: "+b)}I||(I=a.getContext("2d"),ia?(da=document.createElement("canvas"),da.width=a.width,da.height=a.height,A=da.getContext("2d"),A.M=a.width,A.H=a.height):
A=I,(!I||!A)&&g("Error initializing graphic context!"),F=k);wa();$(C).mousedown(Va);$(C).mousemove(Wa);$(C).mouseup(Xa);F&&xa();var a=window.location.search.substring(1).split("&"),c;for(c in a){var e=a[c].split("=");"_cdbg"==e[0]&&"1"==e[1]&&(oa=i,console.log("debug mode on"))}ua=document.getElementById("debug-info");pa.texture=Ka;qa.texture=Ma;qa["default"]=Na});t("chesterGL.canvasResized",wa);t("chesterGL.initShader",ya);t("chesterGL.registerAssetHandler",function(a,b){pa[a]=b});
t("chesterGL.loadAsset",N);t("chesterGL.assetsLoaded",Aa);t("chesterGL.getAsset",Ja);
t("chesterGL.setupPerspective",function(){var a=I;if(F){a.clearColor(0,0,0,1);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);a.enable(a.BLEND);a.disable(a.DEPTH_TEST);var b=a.M,c=a.H;a.viewport(0,0,b,c);K=Za();if("2d"==ha)console.log("setting up 2d projection ("+b+","+c+")"),$a(K,2/(b-0),0,0,0,0,2/(c-0),0,0,0,0,-2/2048,0,-(b+0)/(b-0),-(c+0)/(c-0),-0.0,1);else if("3d"==ha){console.log("setting up 3d projection ("+b+","+c+")");var e=c/1.1566;var a=Za(),d=b/c,f=60*Math.PI/180/2,h=Math.sin(f);0==h||0==
d||(f=Math.cos(f)/h,$a(a,f/d,0,0,0,0,f,0,0,0,0,-1500.5/1499.5,-1,0,0,-1500/1499.5,0));e=[b/2,c/2,e];d=[b/2,c/2,0];b=Za();c=ab[0];c[0]=d[0]-e[0];c[1]=d[1]-e[1];c[2]=d[2]-e[2];bb(c,c);c[3]=0;d=ab[1];cb(c,[0,1,0],d);bb(d,d);d[3]=0;f=ab[2];cb(d,c,f);bb(f,f);f[3]=0;c[0]=-c[0];c[1]=-c[1];c[2]=-c[2];db(b,0,d);db(b,1,f);db(b,2,c);b[3]=0;b[7]=0;b[11]=0;b[15]=1;eb(b,-e[0],-e[1],-e[2]);fb(a,b,K)}else g("Invalid projection: "+ha)}});t("chesterGL.setRunningScene",function(a){a.type==Q.SCENE&&(na=a)});
t("chesterGL.drawScene",Oa);t("chesterGL.run",Ya);t("chesterGL.togglePause",function(){ka?(ka=k,Ya()):ka=i});t("chesterGL.addMouseHandler",function(a){-1==M.indexOf(a)&&M.push(a)});t("chesterGL.removeMouseHandler",function(a){a=M.indexOf(a);0<a&&M.splice(a,1)});function P(a,b){this.width=a;this.height=b}P.prototype.toString=function(){return"("+this.width+" x "+this.height+")"};P.prototype.floor=function(){this.width=Math.floor(this.width);this.height=Math.floor(this.height);return this};P.prototype.scale=function(a){this.width*=a;this.height*=a;return this};function R(a){this.length=a.length||a;for(var b=0;b<this.length;b++)this[b]=a[b]||0}R.prototype.BYTES_PER_ELEMENT=8;R.prototype.set=function(a,b){for(var b=b||0,c=0;c<a.length&&b+c<this.length;c++)this[b+c]=a[c]};R.prototype.toString=Array.prototype.join;"undefined"==typeof Float64Array&&(R.BYTES_PER_ELEMENT=8,R.prototype.BYTES_PER_ELEMENT=R.prototype.BYTES_PER_ELEMENT,R.prototype.set=R.prototype.set,R.prototype.toString=R.prototype.toString,t("Float64Array",R));function S(a){this.length=a.length||a;for(var b=0;b<this.length;b++)this[b]=a[b]||0}S.prototype.BYTES_PER_ELEMENT=4;S.prototype.set=function(a,b){for(var b=b||0,c=0;c<a.length&&b+c<this.length;c++)this[b+c]=a[c]};S.prototype.toString=Array.prototype.join;"undefined"==typeof Float32Array&&(S.BYTES_PER_ELEMENT=4,S.prototype.BYTES_PER_ELEMENT=S.prototype.BYTES_PER_ELEMENT,S.prototype.set=S.prototype.set,S.prototype.toString=S.prototype.toString,t("Float32Array",S));function gb(a){var b=new Float32Array(3);b[0]=a[0];b[1]=a[1];b[2]=a[2];return b}function bb(a,b){var c=a[0],e=a[1],d=a[2],c=1/Math.sqrt(c*c+e*e+d*d);b[0]=a[0]*c;b[1]=a[1]*c;b[2]=a[2]*c}function cb(a,b,c){var e=a[0],d=a[1],a=a[2],f=b[0],h=b[1],b=b[2];c[0]=d*b-a*h;c[1]=a*f-e*b;c[2]=e*h-d*f};function hb(a){var b=new Float32Array(4);b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b}function ib(a,b,c,e){var d=new Float32Array(4);d[0]=a;d[1]=b;d[2]=c;d[3]=e;return d};function Za(){return new Float32Array(16)}function $a(a,b,c,e,d,f,h,r,q,o,l,u,z,v,B,s,w){a[0]=b;a[1]=c;a[2]=e;a[3]=d;a[4]=f;a[5]=h;a[6]=r;a[7]=q;a[8]=o;a[9]=l;a[10]=u;a[11]=z;a[12]=v;a[13]=B;a[14]=s;a[15]=w}function db(a,b,c){a[b]=c[0];a[b+4]=c[1];a[b+8]=c[2];a[b+12]=c[3]}function jb(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a}
function fb(a,b,c){var e=a[0],d=a[1],f=a[2],h=a[3],r=a[4],q=a[5],o=a[6],l=a[7],u=a[8],z=a[9],v=a[10],B=a[11],s=a[12],w=a[13],x=a[14],a=a[15],E=b[0],D=b[1],J=b[2],G=b[3],H=b[4],T=b[5],p=b[6],Ba=b[7],Ca=b[8],Da=b[9],Ea=b[10],Fa=b[11],Ga=b[12],Ha=b[13],Ia=b[14],b=b[15];c[0]=e*E+r*D+u*J+s*G;c[1]=d*E+q*D+z*J+w*G;c[2]=f*E+o*D+v*J+x*G;c[3]=h*E+l*D+B*J+a*G;c[4]=e*H+r*T+u*p+s*Ba;c[5]=d*H+q*T+z*p+w*Ba;c[6]=f*H+o*T+v*p+x*Ba;c[7]=h*H+l*T+B*p+a*Ba;c[8]=e*Ca+r*Da+u*Ea+s*Fa;c[9]=d*Ca+q*Da+z*Ea+w*Fa;c[10]=f*Ca+o*
Da+v*Ea+x*Fa;c[11]=h*Ca+l*Da+B*Ea+a*Fa;c[12]=e*Ga+r*Ha+u*Ia+s*b;c[13]=d*Ga+q*Ha+z*Ia+w*b;c[14]=f*Ga+o*Ha+v*Ia+x*b;c[15]=h*Ga+l*Ha+B*Ia+a*b}function kb(a,b,c){var e=b[0],d=b[1],b=b[2];c[0]=e*a[0]+d*a[4]+b*a[8]+a[12];c[1]=e*a[1]+d*a[5]+b*a[9]+a[13];c[2]=e*a[2]+d*a[6]+b*a[10]+a[14]}function eb(a,b,c,e){var d=a[1]*b+a[5]*c+a[9]*e+a[13],f=a[2]*b+a[6]*c+a[10]*e+a[14],h=a[3]*b+a[7]*c+a[11]*e+a[15];a[12]=a[0]*b+a[4]*c+a[8]*e+a[12];a[13]=d;a[14]=f;a[15]=h}new Float64Array(3);new Float64Array(3);
var ab=[new Float64Array(4),new Float64Array(4),new Float64Array(4)];new Float64Array(16);function U(a,b,c){this.type=b||Q.STANDALONE;c&&(this.parent=c);this.children=[];this.e=V.DEFAULT;a&&this.L(a);this.type==Q.STANDALONE&&this.wa([1,1,1,1]);if(F&&this.type==Q.STANDALONE&&(!c||c.type!=Q.BLOCKGROUP))this.i=I.createBuffer(),this.g=new Float32Array(36);this.b=Za();this.l=Za();this.b=jb(Za());this.V=[];this.W=[]}
var V={DEFAULT:0,TEXTURE:1},lb=["default","texture"],Q={STANDALONE:0,BLOCKGROUP:1,SCENE:2,TMXBLOCK:3,PARTICLE:4,PRIMITIVE:5},mb=Math.PI/180,nb=180/Math.PI,ob=1*mb,pb=ib(0,0,1,1),qb=new P(0,0);m=U.prototype;m.title="";m.b=j;m.l=j;m.Da=i;m.f=k;m.C=k;m.t=k;m.X=0;m.i=j;m.g=j;m.position=new Float32Array(3);m.r=j;m.color=ib(1,1,1,1);m.d=j;m.opacity=1;m.rotation=0;m.scale=1;m.update=j;m.frame=j;m.parent=j;m.children=j;m.V=j;m.W=j;m.J=k;
function rb(a){if(a.e==V.TEXTURE){var b=new W(1,1);a.q(b);b.xa(function(){var a=this.parent.r,b=a.width/2,a=a.height/2;this.ma([[-b,-a,0],[-b,a,0],[b,a,0],[b,-a,0]],[1,1,1,1],i)})}}m.L=function(a){if("string"===typeof a){var b=X.ra(a),a=b.frame;this.S(b.d)}this.frame=hb(a);this.ja(a[2],a[3]);this.t=i};m.ja=function(a,b){this.r=new P(a,b);this.t=i};m.Oa=function(a){this.scale=a;this.f=i};m.wa=function(a){this.color=hb(a);this.C=i};m.R=function(a){this.position=gb(a);this.f=i};
m.S=function(a){this.d=a;this.e=V.TEXTURE;oa&&rb(this);var b=this;N("texture",a,function(a){b.r||b.ja(a.width,a.height);b.frame||b.L([0,0,a.width,a.height])})};m.Na=function(a){this.rotation=a;this.f=i};m.xa=function(a){this.update=a};m.q=function(a){a.parent&&g("can't add a block twice!");this.J?this.V.push(a):(this.children.push(a),a.parent=this)};
m.removeChild=function(a){(!a.parent||a.parent!=this)&&g("not our child!");this.J?this.W.push(a):(a=this.children.indexOf(a),0<=a&&this.children.splice(a,1))};
m.transform=function(){var a=I;if(this.f||this.parent&&this.parent.f){this.b=jb(this.b);eb(this.b,this.position[0],this.position[1],this.position[2]);var b=this.b,c=this.rotation*(F?-1:1),e=b[0],d=b[1],f=b[2],h=b[3],r=b[4],q=b[5],o=b[6],l=b[7],u=b[8],z=b[9],v=b[10],B=b[11],s=Math.cos(c),w=Math.sin(c),x=1-s,c=0*x+s,E=0*x+1*w,D=0*x-0*w,J=0*x-1*w,G=0*x+s,H=0*x+0*w,T=0*x+0*w,w=0*x-0*w,s=1*x+s;$a(b,e*c+r*E+u*D,d*c+q*E+z*D,f*c+o*E+v*D,h*c+l*E+B*D,e*J+r*G+u*H,d*J+q*G+z*H,f*J+o*G+v*H,h*J+l*G+B*H,e*T+r*w+
u*s,d*T+q*w+z*s,f*T+o*w+v*s,h*T+l*w+B*s,b[12],b[13],b[14],b[15]);b=this.b;d=e=this.scale;$a(b,b[0]*e,b[1]*e,b[2]*e,b[3]*e,b[4]*d,b[5]*d,b[6]*d,b[7]*d,1*b[8],1*b[9],1*b[10],1*b[11],b[12],b[13],b[14],b[15]);(b=this.parent?this.parent.b:j)&&fb(b,this.b,this.b)}if(!(this.type==Q.BLOCKGROUP||this.type==Q.PRIMITIVE))if(b=this.g,e=this.parent&&this.parent.type==Q.BLOCKGROUP,F){!e&&(this.t||this.C)&&a.bindBuffer(a.ARRAY_BUFFER,this.i);if(this.t||e&&this.f){var p=9,o=0.5*this.r.width,l=0.5*this.r.height,d=
36*this.X,f=this.position[2];e?(h=[o,l,0],r=[-o,l,0],q=[o,-l,0],o=[-o,-l,0],kb(this.b,h,h),kb(this.b,r,r),kb(this.b,o,o),kb(this.b,q,q),b[d]=o[0],b[d+1]=o[1],b[d+2]=f,b[d+p]=r[0],b[d+1+p]=r[1],b[d+2+p]=f,b[d+2*p]=q[0],b[d+1+2*p]=q[1],b[d+2+2*p]=f,b[d+3*p]=h[0],b[d+1+3*p]=h[1],b[d+2+3*p]=f):(b[d]=-o,b[d+1]=-l,b[d+2]=0,b[d+p]=-o,b[d+1+p]=l,b[d+2+p]=0,b[d+2*p]=o,b[d+1+2*p]=-l,b[d+2+2*p]=0,b[d+3*p]=o,b[d+1+3*p]=l,b[d+2+3*p]=0);this.e==V.TEXTURE&&(f=Ja("texture",this.d),r=f.width,q=f.height,f=this.frame[0]/
r,h=this.frame[1]/q,r=this.frame[2]/r,q=this.frame[3]/q,d+=3,b[d]=f,b[d+1]=h,b[d+p]=f,b[d+1+p]=h+q,b[d+2*p]=f+r,b[d+1+2*p]=h,b[d+3*p]=f+r,b[d+1+3*p]=h+q)}if(this.C){d=5+36*this.X;f=this.color;h=this.opacity;for(r=0;4>r;r++)b[d+p*r]=f[0]*h,b[d+1+p*r]=f[1]*h,b[d+2+p*r]=f[2]*h,b[d+3+p*r]=f[3]*h}F&&!e&&(this.t||this.C)&&a.bufferData(a.ARRAY_BUFFER,this.g,a.STATIC_DRAW)}};
m.I=function(){this.J=i;this.update&&this.update(ta);if(this.Da){this.transform();for(var a=this.children,b=a.length,c=0;c<b;c++)a[c].I();(!this.parent||this.parent.type!=Q.BLOCKGROUP)&&this.F();for(this.J=this.t=this.C=this.f=k;a=this.V.shift();)this.q(a);for(;a=this.W.shift();)this.removeChild(a)}else this.J=k};
m.F=function(){this.type==Q.BLOCKGROUP&&g("Cannot call render on a BlockGroup block!");if(this.type!=Q.SCENE)if(F){var a=I,b=va(lb[this.e]);a.bindBuffer(a.ARRAY_BUFFER,this.i);a.vertexAttribPointer(b.a.vertexPositionAttribute,3,a.FLOAT,k,36,0);a.vertexAttribPointer(b.a.vertexColorAttribute,4,a.FLOAT,k,36,20);if(this.e!=V.DEFAULT&&this.e==V.TEXTURE){var c=Ja("texture",this.d);a.vertexAttribPointer(b.a.textureCoordAttribute,2,a.FLOAT,k,36,12);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,c.T);
a.uniform1i(b.ha,0);a.Xa=i}(this.f||this.parent&&this.parent.f)&&fb(K,this.b,this.l);a.uniformMatrix4fv(b.o,k,this.l);a.drawArrays(a.TRIANGLE_STRIP,0,4)}else if(a=A,1==this.e){b=this.b;c=Ja("texture",this.d);a.globalAlpha=this.opacity;a.setTransform(b[0],b[1],b[4],b[5],b[12],a.H-b[13]);var b=this.r.width,e=this.r.height,d=this.frame;a.drawImage(c,d[0],c.height-(d[1]+e),d[2],d[3],-b/2,-e/2,b,e)}};t("chesterGL.Block",U);t("chesterGL.Block.FullFrame",pb);t("chesterGL.Block.SizeZero",qb);
t("chesterGL.Block.TYPE",Q);t("chesterGL.Block.PROGRAM",V);t("chesterGL.Block.PROGRAM_NAME",lb);t("chesterGL.Block.DEG_TO_RAD",mb);t("chesterGL.Block.RAD_TO_DEG",nb);t("chesterGL.Block.ONE_DEG",ob);U.prototype.title=U.prototype.title;U.prototype.addChild=U.prototype.q;U.prototype.removeChild=U.prototype.removeChild;U.prototype.setPosition=U.prototype.R;U.prototype.setRotation=U.prototype.Na;U.prototype.setColor=U.prototype.wa;U.prototype.setFrame=U.prototype.L;U.prototype.setContentSize=U.prototype.ja;
U.prototype.setTexture=U.prototype.S;U.prototype.setScale=U.prototype.Oa;U.prototype.setUpdate=U.prototype.xa;function sb(a,b){this.U=1E3*a;this.v=b;this.s=0}m=sb.prototype;m.v=j;m.U=0;m.s=0;m.B=k;m.G=k;m.update=function(a){this.G||(this.ka(),this.G=i);this.s+=a;0<this.U&&this.s>=this.U&&(this.B=i)};m.ka=function(){};function tb(a,b,c){sb.call(this,b,c);this.Z=gb(a)}y(tb,sb);tb.prototype.Z=j;tb.prototype.Aa=j;var ub=new Float32Array(3);
tb.prototype.update=function(a){sb.prototype.update.call(this,a);a=this.v;if(this.B)a.R(this.Z);else{var b=this.Aa,c=this.Z,e=Math.min(1,this.s/this.U),d=b[0],f=b[1],b=b[2];ub[0]=(c[0]-d)*e+d;ub[1]=(c[1]-f)*e+f;ub[2]=(c[2]-b)*e+b;a.R(ub)}};tb.prototype.ka=function(){this.v||g("invalid move action! - now block");this.Aa=this.v.position};function vb(a,b,c,e){this.delay=1E3*a;a=this.delay*b.length;c===i&&(a=-1);sb.call(this,a,e);this.ya=c===i;this.frames=b.slice(0)}y(vb,sb);m=vb.prototype;m.z=0;
m.delay=0;m.frames=j;m.ya=k;m.update=function(a){sb.prototype.update.call(this,a);a=this.v;this.B?(this.z=this.frames.length-1,this.B=i,a.L(this.frames[this.z])):this.s>=this.delay*this.z&&(a.L(this.frames[this.z++]),this.z==this.frames.length&&(this.ya?this.s=this.z=0:this.B=i))};var O={ia:[]};O.va=function(a){O.ia.push(a)};O.Pa=function(){for(var a=ta,b=0,c=O.ia.length,b=0;b<c;b++){var e=O.ia[b];!e.B&&e.update(a)}};U.prototype.Ma=function(a){a.v=this;O.va(a)};t("chesterGL.ActionManager",O);
t("chesterGL.MoveToAction",tb);t("chesterGL.AnimateAction",vb);O.scheduleAction=O.va;U.prototype.runAction=U.prototype.Ma;var X={frames:{}};X.Ja=function(a){if(a.meta&&"1.0"==a.meta.version){var b=a.meta.image;N("texture",b,function(c){var c=c.height,e=a.frames,d;for(d in e){var f=e[d],h={frame:{},d:""};h.frame=ib(f.frame.x,c-(f.frame.y+f.frame.h),f.frame.w,f.frame.h);h.d=b;X.frames[d]=h}})}else g("Unkown json data")};X.Ha=function(a,b){L.frameset[a].data=b;return i};X.ra=function(a){return X.frames[a]};X.Ia=function(a){console.log("loadFrames: will fetch "+a);N("frameset",{path:a,dataType:"json"},function(a){X.Ja(a)})};
pa.frameset=X.Ha;t("chesterGL.BlockFrames",X);X.getFrame=X.ra;X.loadFrames=X.Ia;function W(a,b){F||g("PrimitiveBlock only works on WebGL mode");this.fa=a||500;this.ea=b||500;U.call(this,j,Q.PRIMITIVE);var c=I;this.aa=c.createBuffer();this.j=new Float32Array(7*this.fa);this.$=c.createBuffer();this.c=new Float32Array(14*this.ea);this.e=V.DEFAULT}y(W,U);m=W.prototype;m.aa=j;m.j=j;m.$=j;m.c=j;m.ea=0;m.m=0;m.fa=0;m.n=0;m.D=[];
m.Ga=function(a,b,c){if(this.n<this.fa){var e=7*this.n,c=c||[1,1,1,1];this.j[e+0]=a;this.j[e+1]=b;this.j[e+2]=0;this.j[e+3]=c[0];this.j[e+4]=c[1];this.j[e+5]=c[2];this.j[e+6]=c[3];this.n++}else g("too many points!")};
m.Fa=function(a,b,c,e,d){if(this.m<this.ea){var f=14*this.m,d=d||[1,1,1,1];this.c[f+0]=a;this.c[f+1]=b;this.c[f+2]=0;this.c[f+3]=d[0];this.c[f+4]=d[1];this.c[f+5]=d[2];this.c[f+6]=d[3];this.c[f+7]=c;this.c[f+8]=e;this.c[f+9]=0;this.c[f+10]=d[0];this.c[f+11]=d[1];this.c[f+12]=d[2];this.c[f+13]=d[3];this.m++}else g("too many lines!")};
m.ma=function(a,b,c,e){for(var b=b||[1,1,1,1],c=c||k,e=e||k,d=a.length,f=I,h=new Float32Array(7*a.length),r=f.createBuffer(),q=0;q<d;q++){var o=a[q];h[7*q+0]=o[0];h[7*q+1]=o[1];h[7*q+2]=o[2];h[7*q+3]=b[0];h[7*q+4]=b[1];h[7*q+5]=b[2];h[7*q+6]=b[3]}f.bindBuffer(f.ARRAY_BUFFER,r);f.bufferData(f.ARRAY_BUFFER,h,f.STATIC_DRAW);this.D.unshift([h,r,c,e])};m.I=function(){this.m=this.n=0;0<this.D.length&&(this.D=[]);U.prototype.I.call(this)};
m.F=function(){var a=I,b=va(lb[this.e]);if(0<this.n||0<this.m||0<this.D.length)fb(K,this.b,this.l),a.uniformMatrix4fv(b.o,k,this.l);if(0<this.n){var c=I,e=7*this.n;c.bindBuffer(c.ARRAY_BUFFER,this.aa);c.bufferData(c.ARRAY_BUFFER,this.j.subarray(0,e),c.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,this.aa);a.vertexAttribPointer(b.a.vertexPositionAttribute,3,a.FLOAT,k,28,0);a.vertexAttribPointer(b.a.vertexColorAttribute,4,a.FLOAT,k,28,12);a.drawArrays(a.POINTS,0,this.n)}0<this.m&&(c=I,e=14*this.m,c.bindBuffer(c.ARRAY_BUFFER,
this.$),c.bufferData(c.ARRAY_BUFFER,this.c.subarray(0,e),c.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.$),a.vertexAttribPointer(b.a.vertexPositionAttribute,3,a.FLOAT,k,28,0),a.vertexAttribPointer(b.a.vertexColorAttribute,4,a.FLOAT,k,28,12),a.drawArrays(a.LINES,0,2*this.m));c=this.D.length;if(0<c)for(e=0;e<c;e++){var d=this.D[e];a.bindBuffer(a.ARRAY_BUFFER,d[1]);a.vertexAttribPointer(b.a.vertexPositionAttribute,3,a.FLOAT,k,28,0);a.vertexAttribPointer(b.a.vertexColorAttribute,4,a.FLOAT,k,28,12);d[2]?
a.drawArrays(a.LINE_LOOP,0,d[0].length/7):a.drawArrays(a.LINE_STRIP,0,d[0].length/7)}};t("chesterGL.PrimitiveBlock",W);W.prototype.drawPoint=W.prototype.Ga;W.prototype.drawLine=W.prototype.Fa;W.prototype.drawPolygon=W.prototype.ma;var wb,xb,yb,zb;function Ab(){return n.navigator?n.navigator.userAgent:j}zb=yb=xb=wb=k;var Bb;if(Bb=Ab()){var Cb=n.navigator;wb=0==Bb.indexOf("Opera");xb=!wb&&-1!=Bb.indexOf("MSIE");yb=!wb&&-1!=Bb.indexOf("WebKit");zb=!wb&&!yb&&"Gecko"==Cb.product}var Db=wb,Eb=xb,Fb=zb,Gb=yb;var Hb;if(Db&&n.opera){var Ib=n.opera.version;"function"==typeof Ib&&Ib()}else Fb?Hb=/rv\:([^\);]+)(\)|;)/:Eb?Hb=/MSIE\s+([^\);]+)(\)|;)/:Gb&&(Hb=/WebKit\/(\S+)/),Hb&&Hb.exec(Ab());var Jb=j,Kb=j,Lb=Fb||Gb||Db||"function"==typeof n.atob;function Mb(a){(a=Nb[a])||g("Invalid map - make sure you call loadTMX first");U.call(this,j,Q.TMXBLOCK);for(var b=0;b<a.layers.length;b++){for(var c=a.layers[b],e=F?new Y(a.texture,c.blocks.length):new U,d=0;d<c.blocks.length;d++){var f=c.blocks[d],h=aa;F?h=e.la(f.frame):(h=new U(f.frame),h.S(a.texture));h.R(f.position);e.q(h)}this.q(e)}}y(Mb,U);Mb.prototype.F=function(){};var Nb={};pa.tmx=function(a,b){console.log("tmx loaded: "+a);L.tmx[a].data=b;return i};t("chesterGL.TMXBlock",Mb);
Mb.loadTMX=function(a){N("tmx",{path:a,dataType:"xml"},function(b){var c={},b=$(b).find("map"),e=b.find("tileset").first(),d=b.attr("orientation");if(e){c.tileSize=new P(parseInt(e.attr("tilewidth"),10),parseInt(e.attr("tileheight"),10));c.mapTileSize=new P(parseInt(b.attr("tilewidth"),10),parseInt(b.attr("tileheight"),10));e.attr("spacing")&&(c.spacing=parseInt(e.attr("spacing"),10));e.attr("margin")&&(c.margin=parseInt(e.attr("margin"),10));var e=e.find("image").first(),f=new P(parseInt(e.attr("width"),
10),parseInt(e.attr("height"),10));c.texture=e.attr("source");N("texture",c.texture);c.layers=[];b.find("layer").each(function(a,b){var e={blocks:[]},o=new P(parseInt($(b).attr("width"),10),parseInt($(b).attr("height"),10)),l=$(b).find("data").first();if(l){("base64"!=l.attr("encoding")||l.attr("compression"))&&g("Invalid TMX Data");l=l.text().trim();if(Lb)l=n.atob(l);else{if(!Jb){Jb={};Kb={};for(var u=0;65>u;u++)Jb[u]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(u),
Kb[Jb[u]]=u}for(var u=Kb,z=[],v=0;v<l.length;){var B=u[l.charAt(v++)],s=v<l.length?u[l.charAt(v)]:0;++v;var w=v<l.length?u[l.charAt(v)]:0;++v;var x=v<l.length?u[l.charAt(v)]:0;++v;(B==j||s==j||w==j||x==j)&&g(Error());z.push(B<<2|s>>4);64!=w&&(z.push(s<<4&240|w>>2),64!=x&&z.push(w<<6&192|x))}l=String.fromCharCode.apply(j,z)}for(z=u=0;z<o.height;z++)for(v=0;v<o.width;v++){var x=((l.charCodeAt(u+3)&255)<<24|(l.charCodeAt(u+2)&255)<<16|(l.charCodeAt(u+1)&255)<<8|l.charCodeAt(u+0)&255)-1,B={},E=c.margin||
0,D=c.spacing||0,s=c.tileSize,w=c.mapTileSize,J=parseInt((f.width-2*E+D)/(s.width+D),10),x=ib(x%J*(s.width+D)+E,f.height-s.height-E-D-parseInt(x/J,10)*(s.height+D)+E,s.width,s.height);B.frame=x;var G,H;"orthogonal"==d?(G=v*w.width+s.width/2,H=(o.height-z-1)*w.height+s.height/2):"isometric"==d?(G=w.width/2*(o.width+v-z-1)+s.width/2,H=w.height/2*(2*o.height-v-z-2)+s.height/2):g("Invalid orientation");B.position=[G,H,0];e.blocks.push(B);u+=4}}else g("No data for layer!");c.layers.push(e)})}Nb[a]=c})};function Z(a){U.call(this,j,4);var b=this;N("texture",a.texture,function(){b.ta(a)})}y(Z,U);var Ob=k;
function Pb(){ya("particles",function(a){var b=I;a.o=b.getUniformLocation(a,"uMVPMatrix");a.Qa=b.getUniformLocation(a,"uSampler");a.Ta=b.getUniformLocation(a,"u_time");a.Sa=b.getUniformLocation(a,"u_startColor");a.Ra=b.getUniformLocation(a,"u_endColor");a.a={a_startPosition:b.getAttribLocation(a,"a_startPosition"),a_lifetime:b.getAttribLocation(a,"a_lifetime"),a_startTime:b.getAttribLocation(a,"a_startTime"),a_startSize:b.getAttribLocation(a,"a_startSize"),a_endSize:b.getAttribLocation(a,"a_endSize"),
a_speed:b.getAttribLocation(a,"a_speed")};a=b.getError();0!=a&&console.log("gl error: "+a)});Ob=i}m=Z.prototype;m.G=i;m.ua=j;m.na=0;m.A=0;m.p=0;m.u=0;m.duration=0;m.da=0;m.sa=0;m.za=j;m.Q=j;m.oa=j;m.O=j;m.P=j;m.Ba=0;m.Ca=0;m.pa=0;m.qa=0;m.ga=k;m.elapsedTime=0;m.Y=["SRC_ALPHA","ONE_MINUS_SRC_ALPHA"];
m.ta=function(a){this.e=-1;Ob||Pb();this.ua=a.texture;this.u=a.maxParticles;this.duration=1E3*parseFloat(a.duration);this.da=1E3*parseFloat(a.lifetime);this.sa=1E3*parseFloat(a.lifetimeVariance);this.za=hb(a.startColor);this.Q=gb(a.positionVariance);this.oa=hb(a.endColor);this.O=gb(a.speed);this.P=gb(a.speedVariance);this.Ba=parseFloat(a.startSize);this.Ca=parseFloat(a.startSizeVariance);this.pa=parseFloat(a.endSize);this.qa=parseFloat(a.endSizeVariance);this.elapsedTime=0;this.Y=a.blendOptions.slice(0);
this.G=i;this.i=I.createBuffer();this.g=new Float32Array(10*this.u);for(var a=va("particles"),b=I,c=0;c<this.u;c++)Qb(this,c);b.uniform4fv(a.Sa,this.za);b.uniform4fv(a.Ra,this.oa);b.uniform1i(a.Qa,0);Rb(this);this.p=this.A=0;this.na=this.u/Math.abs(this.da)};
function Qb(a,b,c,e){var d=a.g;d[10*b+0]=c||-1;d[10*b+1]=e||0;d[10*b+2]=a.Ba+a.Ca*(2*Math.random()-1);d[10*b+3]=a.pa+a.qa*(2*Math.random()-1);d[10*b+4]=a.O[0]+a.P[0]*(2*Math.random()-1);d[10*b+5]=a.O[1]+a.P[1]*(2*Math.random()-1);d[10*b+6]=a.O[2]+a.P[2]*(2*Math.random()-1);d[10*b+7]=(2*Math.random()-1)*a.Q[0];d[10*b+8]=(2*Math.random()-1)*a.Q[1];d[10*b+9]=(2*Math.random()-1)*a.Q[2]}function Rb(a){var b=I;b.bindBuffer(b.ARRAY_BUFFER,a.i);b.bufferData(b.ARRAY_BUFFER,a.g,b.STATIC_DRAW)}var Sb=new Float32Array(10);
Z.prototype.update=function(a){if(va("particles")){this.elapsedTime+=a;var b=1/this.na;for(this.A+=a;this.p<this.u&&this.A>b&&this.G;)Qb(this,this.p,Math.abs(this.da+this.sa*(2*Math.random()-1)),this.elapsedTime),this.p++,this.ga=i,this.A-=b;for(a=0;a<this.u;a++){var b=this.g,c=10*a;if(0<b[c]&&b[c]+b[c+1]<=this.elapsedTime&&a!=this.p-1){var e=b.subarray(c,c+10);Sb.set(e);Sb[0]=-1;e=b.subarray(c+10,10*this.p);b.set(e,c);b.set(Sb,10*(this.p-1));this.p--}}0<this.duration&&this.elapsedTime>this.duration&&
(this.G=k)}};
Z.prototype.F=function(){var a=va("particles");if(a){var b=I,c=Ja("texture",this.ua);b.enable(b.BLEND);b.blendFunc(b[this.Y[0]],b[this.Y[1]]);this.ga&&(Rb(this),this.ga=k);b.uniform1f(a.Ta,this.elapsedTime);b.activeTexture(b.TEXTURE0);b.bindTexture(b.TEXTURE_2D,c.T);b.bindBuffer(b.ARRAY_BUFFER,this.i);b.vertexAttribPointer(a.a.a_lifetime,3,b.FLOAT,k,40,0);b.vertexAttribPointer(a.a.a_startTime,3,b.FLOAT,k,40,4);b.vertexAttribPointer(a.a.a_startSize,3,b.FLOAT,k,40,8);b.vertexAttribPointer(a.a.a_endSize,3,
b.FLOAT,k,40,12);b.vertexAttribPointer(a.a.a_speed,3,b.FLOAT,k,40,16);b.vertexAttribPointer(a.a.a_startPosition,3,b.FLOAT,k,40,28);(this.f||this.parent&&this.parent.f)&&fb(K,this.b,this.l);b.uniformMatrix4fv(a.o,k,this.l);b.drawArrays(b.POINTS,0,this.u)}};t("chesterGL.ParticleSystem",Z);Z.loadShaders=Pb;Z.prototype.loadProperties=Z.prototype.ta;function Y(a,b){F||g("BlockGroup only works on WebGL mode");U.call(this,j,Q.BLOCKGROUP);a?(this.d=a,this.e=V.TEXTURE):this.e=V.DEFAULT;this.N=b||10;var c=I;this.i=c.createBuffer();this.g=new Float32Array(36*this.N);this.ba=c.createBuffer();this.k=new Uint16Array(6*this.N)}y(Y,U);m=Y.prototype;m.N=0;m.ca=k;m.ba=j;m.k=j;m.la=function(a){a=new U(a,Q.STANDALONE,this);this.d&&a.S(this.d);return a};
m.q=function(a){this.children.length>=this.N&&g("Error: too many children - Make the initial size of the BlockGroup larger");a.parent!=this&&g("Invalid child: can only add children created with BlockGroup.create");this.d?this.d!=a.d&&g("Invalid child: only can add child with the same texture"):this.d=a.d;this.children.push(a);a.X=this.children.length-1;a.g=this.g;this.ca=i};m.Ka=function(){g("not implemented")};
m.I=function(){this.update&&this.update(ta);if(this.Da){this.transform();for(var a=this.children,b=a.length,c=0;c<b;c++)a[c].I();a=I;a.bindBuffer(a.ARRAY_BUFFER,this.i);a.bufferData(a.ARRAY_BUFFER,this.g,a.STATIC_DRAW);if(this.ca){a=(this.k[-1]||-1)+1;b=Math.max(this.children.length,1);for(c=0;c<b;c++){var e=6*c;this.k[e+0]=a;this.k[e+1]=a+1;this.k[e+2]=a+2;this.k[e+3]=a+2;this.k[e+4]=a+1;this.k[e+5]=a+3;a+=4}a=I;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.ba);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.k,
a.STATIC_DRAW);this.ca=k}this.F();this.t=this.C=this.f=k}};
m.F=function(){var a=I,b=va(lb[this.e]),c=this.children.length;a.bindBuffer(a.ARRAY_BUFFER,this.i);a.vertexAttribPointer(b.a.vertexPositionAttribute,3,a.FLOAT,k,36,0);if(this.e!=V.DEFAULT&&this.e==V.TEXTURE){var e=Ja("texture",this.d);a.vertexAttribPointer(b.a.textureCoordAttribute,2,a.FLOAT,k,36,12);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,e.T);a.uniform1i(b.ha,0)}a.vertexAttribPointer(b.a.vertexColorAttribute,4,a.FLOAT,k,36,20);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.ba);fb(K,this.b,
this.l);a.uniformMatrix4fv(b.o,k,this.l);a.drawElements(a.TRIANGLES,6*c,a.UNSIGNED_SHORT,0)};t("chesterGL.BlockGroup",Y);Y.prototype.createBlock=Y.prototype.la;Y.prototype.addChild=Y.prototype.q;Y.prototype.removeBlock=Y.prototype.Ka;
//@ sourceMappingURL=chester.js.map
